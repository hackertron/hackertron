name: Update Stats

on:
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch stats and update README
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const username = 'hackertron';

            // Fetch core stats via GraphQL
            const result = await github.graphql(`
              query($login: String!) {
                user(login: $login) {
                  repositories(ownerAffiliations: OWNER, first: 100, orderBy: {field: STARGAZERS, direction: DESC}) {
                    totalCount
                    nodes { name, stargazerCount }
                  }
                  pullRequests { totalCount }
                  issues { totalCount }
                  repositoriesContributedTo { totalCount }
                  contributionsCollection {
                    totalCommitContributions
                    restrictedContributionsCount
                  }
                }
              }
            `, { login: username });

            const user = result.user;
            const totalStars = user.repositories.nodes.reduce((sum, r) => sum + r.stargazerCount, 0);
            const totalCommits = user.contributionsCollection.totalCommitContributions + user.contributionsCollection.restrictedContributionsCount;

            // Fetch this year stats
            const now = new Date();
            const yearStart = `${now.getFullYear()}-01-01T00:00:00Z`;
            const yearEnd = `${now.getFullYear()}-12-31T23:59:59Z`;

            const yearResult = await github.graphql(`
              query($login: String!, $from: DateTime!, $to: DateTime!) {
                user(login: $login) {
                  contributionsCollection(from: $from, to: $to) {
                    totalCommitContributions
                    restrictedContributionsCount
                    totalPullRequestContributions
                    totalIssueContributions
                  }
                }
              }
            `, { login: username, from: yearStart, to: yearEnd });

            const y = yearResult.user.contributionsCollection;
            const yearCommits = y.totalCommitContributions + y.restrictedContributionsCount;

            // Fetch lines added/removed from contributor stats per repo
            let totalAdded = 0;
            let totalRemoved = 0;
            const repoNames = user.repositories.nodes.map(r => r.name);

            for (const repo of repoNames) {
              for (let attempt = 0; attempt < 3; attempt++) {
                try {
                  const { data, status } = await github.rest.repos.getContributorsStats({
                    owner: username,
                    repo: repo,
                  });
                  if (status === 202) {
                    await new Promise(r => setTimeout(r, 2000));
                    continue;
                  }
                  if (Array.isArray(data)) {
                    const me = data.find(c => c.author && c.author.login.toLowerCase() === username.toLowerCase());
                    if (me && me.weeks) {
                      for (const week of me.weeks) {
                        totalAdded += week.a;
                        totalRemoved += week.d;
                      }
                    }
                  }
                  break;
                } catch (e) {
                  break;
                }
              }
            }

            const fmtNum = (n) => n.toLocaleString('en-US');

            const table = [
              '| All Time | This Year |',
              '|---|---|',
              `| **${user.repositories.totalCount}** repos | **${fmtNum(yearCommits)}** commits |`,
              `| **${fmtNum(totalCommits)}** commits | **${y.totalIssueContributions}** issues |`,
              `| **${user.issues.totalCount}** issues | **${y.totalPullRequestContributions}** PRs |`,
              `| **${user.pullRequests.totalCount}** PRs | **+${fmtNum(totalAdded)}** lines added |`,
              `| **${totalStars}** stars | **-${fmtNum(totalRemoved)}** lines removed |`,
              `| **${user.repositoriesContributedTo.totalCount}** contributed to | |`,
            ].join('\n');

            const fs = require('fs');
            let readme = fs.readFileSync('README.md', 'utf8');
            const startMarker = '<!-- STATS:START -->';
            const endMarker = '<!-- STATS:END -->';
            const startIdx = readme.indexOf(startMarker);
            const endIdx = readme.indexOf(endMarker);

            if (startIdx !== -1 && endIdx !== -1) {
              readme = readme.substring(0, startIdx + startMarker.length) + '\n' + table + '\n' + readme.substring(endIdx);
              fs.writeFileSync('README.md', readme);
            } else {
              core.setFailed('Could not find STATS markers in README.md');
            }

      - name: Commit and push
        run: |
          git config user.name "hackertron"
          git config user.email "cooljay.gupta@gmail.com"
          git add README.md
          git diff --staged --quiet || (git commit -m "chore: update stats [bot]" && git push)
